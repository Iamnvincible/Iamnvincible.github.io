---
layout: post
title: "MD5 算法的不完全实现"
categories: Algorithm
tags: md5
permalink: /4/
---

MD5 算法是一种已经被证明不安全的消息摘要算法，该算法在 [RFC 1321](https://datatracker.ietf.org/doc/html/rfc1321) 规范中被实现。


在 GNU/Linux 系统中，命令 `md5sum` 可以完成校验文件或输入字符串的工作，该命令包含在 [GNU core utilities](https://www.gnu.org/software/coreutils/) 命令集合中，MD5 算法的核心代码在 [gnulib](https://git.savannah.gnu.org/gitweb/?p=gnulib.git)。

实现 MD5 算法的代码并不复杂，动手实践一遍可以提高动手能力和对规范的理解能力。本文依照规范，尝试实现对简单字符串消息摘要计算。

## 概述

MD5 消息摘要算法接收一段任意长度的输入，输出一个 128 位的“指纹”或“消息摘要”。

一般认为，两段不同的消息不太可能会有一样的消息摘要。同时，也不容易在确定一个目标消息摘要后生成一段会得到这个消息摘要的消息。MD5 算法一般用于数字签名程序，这些程序需要在安全地“压缩”一个大文件后再执行公私钥体系的加密。

MD5 算法在 32 位计算机上运行极快，也不需要替换表，算法代码非常紧凑。

MD5 算法是 MD4 消息摘要算法的扩展。由于 MD5 算法采用了一个更加可靠的设计，所以运行速度会比 MD4 算法稍慢。

## 术语和符号
本文中，“字”是 32 位长度，“字节”是 8 位长度。接收到以“位”组成的消息序列时，可以按照大端字节序规则来将每 8 个位组合成一个字节，同样也可以按小端字节序规则将每 8 个位组成一个字节。

- 下标：`x_i`，表示 i 是 x 的下标。下标是表达式时用括号括起来，如 x_{i+1}。
- 上标：`x^i`，表示 i 是 x 的上标，表示 x 的 i 次幂。
- 循环左移：`X <<< s`，表示 X 向左移动 s 位，位移动是首位循环的。
- 按位取反：`not(X)`。
- 按位或：`X v Y`。
- 按位异或：`x xor Y`。

## MD5 算法描述
假设有一个 b 位长度的消息作为输入，算法计算这段消息的摘要。
- b 可以是任意非负整数，可以是很大的数。
- b 可以是 0。
- b 不一定能被 8 整除。

那么消息可以写作：
```
m_0 m_1 ... m_{b-1}
```
### 第一步：填充长度
将消息填充至其位长度能够在被 512 取模时余 448。即使消息长度刚好被 512 整除余 448 也需要做一次填充。

填充规则：
1. 向消息追加一位 `1`。
2. 继续追加若干位 `0`，直到消息长度能被 512 取模余 448。

按此规则，消息至少填充 1 位，最多填充 512 位。